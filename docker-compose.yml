version: "3.9"

# ─────────────────────────────────────────────────────────────
# MCP MSSQL Server — Docker Compose
#
# Services:
#   mcp-mssql   — the MCP server (SSE/HTTP transport)
#   redis       — schema cache (optional)
#
# Usage:
#   docker compose up --build          # first run
#   docker compose up -d               # background
#   docker compose logs -f mcp-mssql  # watch logs
#   docker compose down                # stop all
# ─────────────────────────────────────────────────────────────

services:

  # ── MCP MSSQL Server ───────────────────────────────────────
  mcp-mssql:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: mcp-mssql
    restart: unless-stopped

    ports:
      - "8000:8000"       # SSE/HTTP endpoint for Claude Desktop

    environment:
      # ── SQL Server connection ────────────────────────────────
      # These override .env values — use your real values here
      # OR reference an .env file via env_file below
      MSSQL_SERVER: ${MSSQL_SERVER}
      MSSQL_DATABASE: ${MSSQL_DATABASE}
      MSSQL_USERNAME: ${MSSQL_USERNAME}
      MSSQL_PASSWORD: ${MSSQL_PASSWORD}
      MSSQL_PORT: ${MSSQL_PORT:-1433}
      MSSQL_DRIVER: ${MSSQL_DRIVER:-ODBC Driver 18 for SQL Server}
      MSSQL_ENCRYPT: ${MSSQL_ENCRYPT:-false}
      MSSQL_TRUST_SERVER_CERT: ${MSSQL_TRUST_SERVER_CERT:-true}

      # ── Connection pool ──────────────────────────────────────
      POOL_SIZE: ${POOL_SIZE:-10}
      POOL_MAX_OVERFLOW: ${POOL_MAX_OVERFLOW:-20}
      POOL_TIMEOUT: ${POOL_TIMEOUT:-30}
      POOL_RECYCLE: ${POOL_RECYCLE:-3600}

      # ── Query safety ─────────────────────────────────────────
      MAX_ROWS: ${MAX_ROWS:-10000}
      QUERY_TIMEOUT: ${QUERY_TIMEOUT:-120}
      ALLOW_WRITE_OPERATIONS: ${ALLOW_WRITE_OPERATIONS:-false}

      # ── Redis cache ──────────────────────────────────────────
      REDIS_ENABLED: "true"
      REDIS_URL: "redis://redis:6379"
      SCHEMA_CACHE_TTL: ${SCHEMA_CACHE_TTL:-3600}

      # ── Server ───────────────────────────────────────────────
      TRANSPORT: "sse"
      HOST: "0.0.0.0"
      PORT: "8000"
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # Python settings
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"

    env_file:
      - .env              # local overrides — gitignored

    depends_on:
      redis:
        condition: service_healthy

    networks:
      - mcp-network

    # Connects to SQL Server on host machine
    # Use host.docker.internal for Windows/Mac
    # Use 172.17.0.1 for Linux host networking
    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ── Redis (Schema Cache) ────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: mcp-mssql-redis
    restart: unless-stopped

    ports:
      - "6379:6379"       # expose if you want to inspect cache locally

    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no

    networks:
      - mcp-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  mcp-network:
    driver: bridge
    name: mcp-network
